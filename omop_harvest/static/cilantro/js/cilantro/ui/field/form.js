define(["underscore","backbone","marionette","loglevel","../../core","../base","../charts","../config","./info","./stats","./controls"],function(e,t,i,n,o,s,r,a,l,c,h){var u=s.LoadView.extend({message:"Loading fields..."}),d=i.Layout.extend({className:"field-form",getTemplate:function(){return this.options.condensed?"field/form-condensed":"field/form"},options:{info:!0,chart:!1,stats:!0,controls:!0,condensed:!1},ui:{apply:"[data-action=apply]",update:"[data-action=update]",state:"[data-target=state]"},events:{"click @ui.apply":"applyFilter","click @ui.update":"applyFilter"},filterEvents:{applied:"renderFilter",unapplied:"renderFilter",change:"renderFilter"},regions:{info:".info-region",stats:".stats-region",chart:".chart-region",controls:".controls-region"},regionViews:{info:l.FieldInfo,stats:c.FieldStats,chart:r.FieldChart,controls:h.FieldControls},initialize:function(e){if(this.data={},!(this.data.concept=e.concept))throw new Error("concept required");if(!(this.data.context=e.context))throw new Error("context required");e.filter||(e.filter=this.data.context.define({concept:this.data.concept.id,field:this.model.id})),this.data.filter=e.filter},onRender:function(){this.$el.attr("id",this.data.filter.id),this.options.condensed&&this.$el.addClass("condensed"),this.options.info&&this.renderInfo(),this.options.stats&&this.model.stats&&this.renderStats(),this.options.controls&&this.renderControls(),this.options.chart&&this.model.links.distribution&&this.renderChart(),this.renderFilter(),i.bindEntityEvents(this,this.data.filter,i.getOption(this,"filterEvents"))},renderInfo:function(){var t={model:this.model};e.isObject(this.options.info)&&e.extend(t,this.options.info),this.info.show(new this.regionViews.info(t))},renderStats:function(){var t={model:this.model,collection:this.model.stats};e.isObject(this.options.stats)&&e.extend(t,this.options.stats),this.stats.show(new this.regionViews.stats(t))},renderControls:function(){var i=[];if(e.each(this.options.controls,function(t){var n={model:this.model,filter:this.data.filter};e.isObject(t)?e.extend(n,t):n.control=t,i.push(n)},this),i.length>0){var n=new this.regionViews.controls({collection:new t.Collection(i)});this.controls.show(n)}},renderChart:function(){var t;t=this.options.condensed?{chart:{height:100}}:{chart:{height:200}},t.context=this.context,t.model=this.model,e.isObject(this.options.chart)&&e.extend(t,this.options.chart),this.chart.show(new this.regionViews.chart(t))},renderFilter:function(){if(this.ui.apply.prop("disabled",!0),this.ui.update.prop("disabled",!0),this.ui.state.hide(),this.data.context.isFilterApplied(this.data.filter)){this.ui.apply.hide(),this.ui.update.show();var t=[];this.controls.currentView.children.each(function(i){i.view&&(t=t.concat(e.keys(i.view.get())))}),this.data.context.hasFilterChanged(this.data.filter,t)&&this.validateFilter({silent:!0})&&(this.ui.apply.prop("disabled",!1),this.ui.update.prop("disabled",!1))}else this.ui.apply.show(),this.ui.update.hide(),this.validateFilter({silent:!0})&&this.ui.apply.prop("disabled",!1)},validateFilter:function(t){t=e.extend({},t);var i,n=[],o=this.data.filter.toJSON();return this.controls.currentView.children.each(function(e){e.view&&(i=e.view.validate(o),i&&n.push(i))}),n.length?(this.validationErrors=n,t.silent||this.ui.state.html(n.join("<br>")).show(),!1):(this.validationErrors=null,this.ui.state.text("").hide(),!0)},applyFilter:function(e){e.preventDefault(),this.validateFilter()&&this.data.filter.apply()}}),p=s.ErrorView.extend({}),f=i.View.extend({itemView:d,emptyView:u,errorView:p,collectionEvents:{reset:"render"},initialize:function(){if(this.data={},!(this.data.concept=this.options.concept))throw new Error("concept required");if(!(this.data.context=this.options.context))throw new Error("context required")},render:function(){if(this.collection.length){var e=this;this.collection.each(function(t,i){e.renderItem(t,i)})}return this},renderItem:function(t,i){var o=e.extend({},this.options,{model:t,context:this.data.context,concept:this.data.concept,index:i});this.collection.length<2?o.info=!1:i>0&&this.options.condense&&(o.condensed=!0);var s=a.resolveFormOptions(t,"fields");if(e.extend(o,s.options),s.module){var r=this;require([s.module],function(e){r.createView(e,o)},function(e){r.showErrorView(t),n.debug(e)})}else this.createView(s.view||this.itemView,o)},createView:function(e,t){try{var i=new e(t);i.render(),o.dom.insertAt(this.$el,t.index,i.el)}catch(n){if(this.showErrorView(t.model),o.config.get("debug"))throw n}},showErrorView:function(e){var t=new this.errorView({model:e});t.render(),this.$el.html(t.el)}}),g=i.ItemView.extend({tagName:"li",template:"field/link",ui:{anchor:"a"},serializeData:function(){return{name:this.model.get("alt_name")||this.model.get("name")}}}),m=i.CompositeView.extend({template:"field/links",itemView:g,itemViewContainer:"[data-target=links]",onAfterItemAdded:function(e){var t=this.options.concept,i="c"+t.id+"f"+e.model.id;e.ui.anchor.attr("href","#"+i)}});return{FieldForm:d,FieldFormCollection:f,FieldLinkCollection:m}});
//@ sourceMappingURL=form.js.map